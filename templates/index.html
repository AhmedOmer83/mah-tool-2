<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Translation and Named Entity Recognition</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div class="container">
    <!-- Aligned Sentences Table -->
    <div class="text-container">
        <table id="alignedSentences">
            <thead>
            <tr>
                <th>Source Text
                    <button id="toggleTranscriptionsButton" class="toggle-header-btn" onclick="toggleTranscriptions()">Hide Transcriptions</button>
                </th>
                <th>Translated Text
                    <button id="toggleTranslationsButton" class="toggle-header-btn" onclick="toggleTranslations()">Hide Translations</button>
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic rows will be appended here -->
            </tbody>
        </table>
    </div>

    <!-- Language Selection and Control -->
    <div class="controls">
        <label for="sourceLanguage">Source Language:</label>
        <select id="sourceLanguage">
            <option value="af">Afrikaans</option>
            <option value="sq">Albanian</option>
            <option value="am">Amharic</option>
            <option value="ar">Arabic</option>
            <option value="hy">Armenian</option>
            <option value="az">Azerbaijani</option>
            <option value="eu">Basque</option>
            <option value="be">Belarusian</option>
            <option value="bn">Bengali</option>
            <option value="bs">Bosnian</option>
            <option value="bg">Bulgarian</option>
            <option value="ca">Catalan</option>
            <option value="ceb">Cebuano</option>
            <option value="ny">Chichewa</option>
            <option value="zh-CN">Chinese (Simplified)</option>
            <option value="zh-TW">Chinese (Traditional)</option>
            <option value="co">Corsican</option>
            <option value="hr">Croatian</option>
            <option value="cs">Czech</option>
            <option value="da">Danish</option>
            <option value="nl">Dutch</option>
            <option value="en" selected>English</option> <!-- Default set to English -->
            <option value="eo">Esperanto</option>
            <option value="et">Estonian</option>
            <option value="tl">Filipino</option>
            <option value="fi">Finnish</option>
            <option value="fr">French</option>
            <option value="fy">Frisian</option>
            <option value="gl">Galician</option>
            <option value="ka">Georgian</option>
            <option value="de">German</option>
            <option value="el">Greek</option>
            <option value="gu">Gujarati</option>
            <option value="ht">Haitian Creole</option>
            <option value="ha">Hausa</option>
            <option value="haw">Hawaiian</option>
            <option value="iw">Hebrew</option>
            <option value="hi">Hindi</option>
            <option value="hmn">Hmong</option>
            <option value="hu">Hungarian</option>
            <option value="is">Icelandic</option>
            <option value="ig">Igbo</option>
            <option value="id">Indonesian</option>
            <option value="ga">Irish</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="jw">Javanese</option>
            <option value="kn">Kannada</option>
            <option value="kk">Kazakh</option>
            <option value="km">Khmer</option>
            <option value="rw">Kinyarwanda</option>
            <option value="ko">Korean</option>
            <option value="ku">Kurdish (Kurmanji)</option>
            <option value="ky">Kyrgyz</option>
            <option value="lo">Lao</option>
            <option value="la">Latin</option>
            <option value="lv">Latvian</option>
            <option value="lt">Lithuanian</option>
            <option value="lb">Luxembourgish</option>
            <option value="mk">Macedonian</option>
            <option value="mg">Malagasy</option>
            <option value="ms">Malay</option>
            <option value="ml">Malayalam</option>
            <option value="mt">Maltese</option>
            <option value="mi">Maori</option>
            <option value="mr">Marathi</option>
            <option value="mn">Mongolian</option>
            <option value="my">Myanmar (Burmese)</option>
            <option value="ne">Nepali</option>
            <option value="no">Norwegian</option>
            <option value="or">Odia (Oriya)</option>
            <option value="ps">Pashto</option>
            <option value="fa">Persian</option>
            <option value="pl">Polish</option>
            <option value="pt">Portuguese</option>
            <option value="pa">Punjabi</option>
            <option value="ro">Romanian</option>
            <option value="ru">Russian</option>
            <option value="sm">Samoan</option>
            <option value="gd">Scots Gaelic</option>
            <option value="sr">Serbian</option>
            <option value="st">Sesotho</option>
            <option value="sn">Shona</option>
            <option value="sd">Sindhi</option>
            <option value="si">Sinhala</option>
            <option value="sk">Slovak</option>
            <option value="sl">Slovenian</option>
            <option value="so">Somali</option>
            <option value="es">Spanish</option>
            <option value="su">Sundanese</option>
            <option value="sw">Swahili</option>
            <option value="sv">Swedish</option>
            <option value="tg">Tajik</option>
            <option value="ta">Tamil</option>
            <option value="tt">Tatar</option>
            <option value="te">Telugu</option>
            <option value="th">Thai</option>
            <option value="tr">Turkish</option>
            <option value="tk">Turkmen</option>
            <option value="uk">Ukrainian</option>
            <option value="ur">Urdu</option>
            <option value="ug">Uyghur</option>
            <option value="uz">Uzbek</option>
            <option value="vi">Vietnamese</option>
            <option value="cy">Welsh</option>
            <option value="xh">Xhosa</option>
            <option value="yi">Yiddish</option>
            <option value="yo">Yoruba</option>
            <option value="zu">Zulu</option>
        </select>

        <label for="targetLanguage">Target Language:</label>
        <select id="targetLanguage">
            <option value="af">Afrikaans</option>
            <option value="sq">Albanian</option>
            <option value="am">Amharic</option>
            <option value="ar">Arabic</option>
            <option value="hy">Armenian</option>
            <option value="az">Azerbaijani</option>
            <option value="eu">Basque</option>
            <option value="be">Belarusian</option>
            <option value="bn">Bengali</option>
            <option value="bs">Bosnian</option>
            <option value="bg">Bulgarian</option>
            <option value="ca">Catalan</option>
            <option value="ceb">Cebuano</option>
            <option value="ny">Chichewa</option>
            <option value="zh-CN">Chinese (Simplified)</option>
            <option value="zh-TW">Chinese (Traditional)</option>
            <option value="co">Corsican</option>
            <option value="hr">Croatian</option>
            <option value="cs">Czech</option>
            <option value="da">Danish</option>
            <option value="nl">Dutch</option>
            <option value="en">English</option>
            <option value="eo">Esperanto</option>
            <option value="et">Estonian</option>
            <option value="tl">Filipino</option>
            <option value="fi">Finnish</option>
            <option value="fr">French</option>
            <option value="fy">Frisian</option>
            <option value="gl">Galician</option>
            <option value="ka">Georgian</option>
            <option value="de">German</option>
            <option value="el">Greek</option>
            <option value="gu">Gujarati</option>
            <option value="ht">Haitian Creole</option>
            <option value="ha">Hausa</option>
            <option value="haw">Hawaiian</option>
            <option value="iw">Hebrew</option>
            <option value="hi">Hindi</option>
            <option value="hmn">Hmong</option>
            <option value="hu">Hungarian</option>
            <option value="is">Icelandic</option>
            <option value="ig">Igbo</option>
            <option value="id">Indonesian</option>
            <option value="ga">Irish</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="jw">Javanese</option>
            <option value="kn">Kannada</option>
            <option value="kk">Kazakh</option>
            <option value="km">Khmer</option>
            <option value="rw">Kinyarwanda</option>
            <option value="ko">Korean</option>
            <option value="ku">Kurdish (Kurmanji)</option>
            <option value="ky">Kyrgyz</option>
            <option value="lo">Lao</option>
            <option value="la">Latin</option>
            <option value="lv">Latvian</option>
            <option value="lt">Lithuanian</option>
            <option value="lb">Luxembourgish</option>
            <option value="mk">Macedonian</option>
            <option value="mg">Malagasy</option>
            <option value="ms">Malay</option>
            <option value="ml">Malayalam</option>
            <option value="mt">Maltese</option>
            <option value="mi">Maori</option>
            <option value="mr">Marathi</option>
            <option value="mn">Mongolian</option>
            <option value="my">Myanmar (Burmese)</option>
            <option value="ne">Nepali</option>
            <option value="no">Norwegian</option>
            <option value="or">Odia (Oriya)</option>
            <option value="ps">Pashto</option>
            <option value="fa">Persian</option>
            <option value="pl">Polish</option>
            <option value="pt">Portuguese</option>
            <option value="pa">Punjabi</option>
            <option value="ro">Romanian</option>
            <option value="ru">Russian</option>
            <option value="sm">Samoan</option>
            <option value="gd">Scots Gaelic</option>
            <option value="sr">Serbian</option>
            <option value="st">Sesotho</option>
            <option value="sn">Shona</option>
            <option value="sd">Sindhi</option>
            <option value="si">Sinhala</option>
            <option value="sk">Slovak</option>
            <option value="sl">Slovenian</option>
            <option value="so">Somali</option>
            <option value="es" selected>Spanish</option> <!-- Default set to Spanish -->
            <option value="su">Sundanese</option>
            <option value="sw">Swahili</option>
            <option value="sv">Swedish</option>
            <option value="tg">Tajik</option>
            <option value="ta">Tamil</option>
            <option value="tt">Tatar</option>
            <option value="te">Telugu</option>
            <option value="th">Thai</option>
            <option value="tr">Turkish</option>
            <option value="tk">Turkmen</option>
            <option value="uk">Ukrainian</option>
            <option value="ur">Urdu</option>
            <option value="ug">Uyghur</option>
            <option value="uz">Uzbek</option>
            <option value="vi">Vietnamese</option>
            <option value="cy">Welsh</option>
            <option value="xh">Xhosa</option>
            <option value="yi">Yiddish</option>
            <option value="yo">Yoruba</option>
            <option value="zu">Zulu</option>
        </select>
    </div>

    <!-- Buttons at the bottom -->
    <div class="button-container">
        <button id="startStopButton" onclick="toggleRecording()">Start</button>
        <button id="clearButton" onclick="clearTextAreas()">Clear</button>
    </div>
</div>

<script>
    let recognition;  // Declare the recognition object globally
    let isRecording = false;
    let transcriptionsVisible = true;
    let translationsVisible = true;

    function toggleRecording() {
        const button = document.getElementById('startStopButton');
        if (isRecording) {
            stopRecording();
            button.textContent = 'Start';  // Update button text to "Start"
        } else {
            startRecording();
            button.textContent = 'Stop';  // Update button text to "Stop"
        }
        isRecording = !isRecording;  // Toggle the recording state
    }

    function startRecording() {
        const sourceLanguage = document.getElementById('sourceLanguage').value;

        if (!('webkitSpeechRecognition' in window)) {
            alert("Your browser doesn't support speech recognition.");
            return;
        }

        // Initialize webkitSpeechRecognition
        recognition = new webkitSpeechRecognition();
        recognition.lang = sourceLanguage;
        recognition.continuous = true;  // Keep recording until stopped
        recognition.interimResults = true;  // Show interim results for real-time display

        // Track the index of the current row for updating
        let currentRowIndex = -1;
        let previousText = '';  // To store previous interim text

        recognition.onresult = function(event) {
            let interimText = '';  // Store the interim results
            let finalText = '';  // Store the final results

            // Process the recognized results
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalText += event.results[i][0].transcript;
                } else {
                    interimText += event.results[i][0].transcript;
                }
            }

            // Display interim results in real-time by appending to previous text only if changed
            if (interimText.trim() && interimText !== previousText) {
                if (currentRowIndex === -1) {  // If no row exists, create a new one
                    currentRowIndex = appendToTable('alignedSentences', [{source: interimText, translation: '...'}], true);
                } else {  // Update the existing row with the interim text
                    updateTableRow('alignedSentences', currentRowIndex, interimText, '...');
                }
                previousText = interimText;  // Update the stored interim text
            }

            // If a final result is available, update the row with finalised text
            if (finalText.trim()) {
                console.log("Recognized text:", finalText);  // Log the new text
                processText(finalText, sourceLanguage, document.getElementById('targetLanguage').value, currentRowIndex);
                currentRowIndex = -1;  // Reset index after final result
                previousText = '';  // Clear previous interim text
            }
        };

        recognition.onerror = function(event) {
            console.error("Speech recognition error detected: " + event.error);
        };

        recognition.onend = function() {
            if (isRecording) {
                recognition.start();  // Restart recognition if it was stopped unexpectedly
            }
        };

        recognition.start();
        console.log("Recording started.");
    }

    function stopRecording() {
        if (recognition) {
            recognition.stop();
            console.log("Recording stopped.");
        }
    }

    async function processText(text, sourceLanguage, targetLanguage, rowIndex) {
        const response = await fetch('/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                sourceLanguage: sourceLanguage,
                targetLanguage: targetLanguage
            })
        });

        const data = await response.json();

        // Use innerHTML to render the HTML-formatted source and translation text
        updateTableRow('alignedSentences', rowIndex, data.sentencePairs[0].source, data.sentencePairs[0].translation);
    }

    function appendToTable(tableId, sentencePairs, isInterim = false) {
        const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
        let rowIndex = tableBody.rows.length;  // Track the row index

        sentencePairs.forEach(pair => {
            const newRow = tableBody.insertRow();

            const sourceCell = newRow.insertCell(0);
            const translationCell = newRow.insertCell(1);

            // Make both cells editable
            sourceCell.contentEditable = true;
            translationCell.contentEditable = true;

            sourceCell.innerHTML = pair.source + (isInterim ? " (interim)" : "");
            translationCell.innerHTML = pair.translation + (isInterim ? " (processing)" : "");
        });

        return rowIndex;
    }

    function updateTableRow(tableId, rowIndex, sourceText, translationText) {
        const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
        if (tableBody.rows[rowIndex]) {
            // Use innerHTML instead of innerText to apply the <span> tags for entities
            tableBody.rows[rowIndex].cells[0].innerHTML = sourceText;
            tableBody.rows[rowIndex].cells[1].innerHTML = translationText;
        }
    }

    function toggleTranscriptions() {
        const transcriptions = document.querySelectorAll('#alignedSentences td:nth-child(1)');
        transcriptions.forEach(td => {
            td.style.visibility = transcriptionsVisible ? 'hidden' : 'visible';
        });
        transcriptionsVisible = !transcriptionsVisible;

        const button = document.getElementById('toggleTranscriptionsButton');
        button.textContent = transcriptionsVisible ? 'Hide Transcriptions' : 'Show Transcriptions';
    }

    function toggleTranslations() {
        const translations = document.querySelectorAll('#alignedSentences td:nth-child(2)');
        translations.forEach(td => {
            td.style.visibility = translationsVisible ? 'hidden' : 'visible';
        });
        translationsVisible = !translationsVisible;

        const button = document.getElementById('toggleTranslationsButton');
        button.textContent = translationsVisible ? 'Hide Translations' : 'Show Translations';
    }

    function clearTextAreas() {
        const tableBody = document.getElementById('alignedSentences').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // Clear the content
    }
</script>
</body>
</html>
