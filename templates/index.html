<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Translation and Named Entity Recognition</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div class="container">
    <!-- Aligned Sentences Table -->
    <div class="text-container">
        <table id="alignedSentences">
            <thead>
            <tr>
                <th>Source Text
                    <button id="toggleTranscriptionsButton" class="toggle-header-btn" onclick="toggleTranscriptions()">Hide Transcriptions</button>
                </th>
                <th>Translated Text
                    <button id="toggleTranslationsButton" class="toggle-header-btn" onclick="toggleTranslations()">Hide Translations</button>
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic rows will be appended here -->
            </tbody>
        </table>
    </div>

    <!-- Language Selection and Control -->
    <div class="controls">
        <label for="sourceLanguage">Source Language:</label>
        <select id="sourceLanguage">
            <option value="en">English</option>
            <option value="fr">French</option>
            <option value="es">Spanish</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ar">Arabic</option>
        </select>

        <label for="targetLanguage">Target Language:</label>
        <select id="targetLanguage">
            <option value="fr">French</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="ar">Arabic</option>
        </select>
    </div>

    <!-- Buttons at the bottom -->
    <div class="button-container">
        <button id="startStopButton" onclick="toggleRecording()">Start</button>
        <button id="clearButton" onclick="clearTextAreas()">Clear</button>
    </div>
</div>

<script>
    let recognition;  // Declare the recognition object globally
    let isRecording = false;
    let transcriptionsVisible = true;
    let translationsVisible = true;

    function toggleRecording() {
        const button = document.getElementById('startStopButton');
        if (isRecording) {
            stopRecording();
            button.textContent = 'Start';  // Update button text to "Start"
        } else {
            startRecording();
            button.textContent = 'Stop';  // Update button text to "Stop"
        }
        isRecording = !isRecording;  // Toggle the recording state
    }

    function startRecording() {
        const sourceLanguage = document.getElementById('sourceLanguage').value;

        if (!('webkitSpeechRecognition' in window)) {
            alert("Your browser doesn't support speech recognition.");
            return;
        }

        // Initialize webkitSpeechRecognition
        recognition = new webkitSpeechRecognition();
        recognition.lang = sourceLanguage;
        recognition.continuous = true;  // Keep recording until stopped
        recognition.interimResults = false;  // Only process final results

        recognition.onresult = function(event) {
            let newText = '';  // Store the new text

            // Process the recognized results
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    newText += event.results[i][0].transcript;
                }
            }

            if (newText.trim()) {
                console.log("Recognized text:", newText);  // Log the new text
                processText(newText, sourceLanguage, document.getElementById('targetLanguage').value);
            }
        };

        recognition.onerror = function(event) {
            console.error("Speech recognition error detected: " + event.error);
        };

        recognition.onend = function() {
            if (isRecording) {
                recognition.start();  // Restart recognition if it was stopped unexpectedly
            }
        };

        recognition.start();
        console.log("Recording started.");
    }

    function stopRecording() {
        if (recognition) {
            recognition.stop();
            console.log("Recording stopped.");
        }
    }

    async function processText(text, sourceLanguage, targetLanguage) {
        const response = await fetch('/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                sourceLanguage: sourceLanguage,
                targetLanguage: targetLanguage
            })
        });

        const data = await response.json();
        appendToTable('alignedSentences', data.sentencePairs);
    }

    function appendToTable(tableId, sentencePairs) {
        const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
        // Instead of clearing the table, append the new rows
        sentencePairs.forEach(pair => {
            const newRow = tableBody.insertRow();

            const sourceCell = newRow.insertCell(0);
            const translationCell = newRow.insertCell(1);

            // Make both cells editable
            sourceCell.contentEditable = true;
            translationCell.contentEditable = true;

            sourceCell.innerHTML = pair.source;
            translationCell.innerHTML = pair.translation;
        });
    }

    function toggleTranscriptions() {
        const transcriptions = document.querySelectorAll('#alignedSentences td:nth-child(1)');
        transcriptions.forEach(td => {
            td.style.visibility = transcriptionsVisible ? 'hidden' : 'visible';
        });
        transcriptionsVisible = !transcriptionsVisible;

        const button = document.getElementById('toggleTranscriptionsButton');
        button.textContent = transcriptionsVisible ? 'Hide Transcriptions' : 'Show Transcriptions';
    }

    function toggleTranslations() {
        const translations = document.querySelectorAll('#alignedSentences td:nth-child(2)');
        translations.forEach(td => {
            td.style.visibility = translationsVisible ? 'hidden' : 'visible';
        });
        translationsVisible = !translationsVisible;

        const button = document.getElementById('toggleTranslationsButton');
        button.textContent = translationsVisible ? 'Hide Translations' : 'Show Translations';
    }

    function clearTextAreas() {
        const tableBody = document.getElementById('alignedSentences').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // Clear the content
    }
</script>
</body>
</html>
